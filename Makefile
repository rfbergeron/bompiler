WARN = -Wall -Wextra -Werror -Wpedantic -Wshadow
#SANITIZE = -fsanitize=address
#DEBUG = -ggdb -pg
CFLAGS = -Ibadlib -Ibadlib/murmur3 -ansi -Og -pg -ggdb -fsanitize=address
C = gcc
CYY = ${C} -Wno-sign-compare
CDEP = ${C} -ansi -MMD ${WARN}
MAKEFILE = Makefile
DEPFILE = .depend
# name of the compiled executable
EXECNAME = bompiler
# .c source files
SRC = debug.c bcc_err.c attributes.c strset.c lyutils.c astree.c symtable.c typecheck.c asmgen.c state.c main.c
# .h header files
HDR = debug.h bcc_err.h attributes.h strset.h lyutils.h astree.h symtable.h typecheck.h asmgen.h state.h simplestack.h
# files generated by flex and bison
GENSRC = yyparse.c yylex.c
GENHDR = yyparse.h
# library files
LIBHDR = badlib/badmap.h badlib/badllist.h badlib/badalist.h
LIBOBJ = badmap.o badllist.o badalist.o murmur3.o
# convenient groups
ALLSRC = ${SRC} ${GENSRC} ${LIBSRC}
ALLHDR = ${HDR} ${GENHDR} ${LIBHDR}
# .o object files
OBJ = $(notdir ${ALLSRC:.c=.o})
# .gch header gens
GCH = ${ALLHDR:=.gch}
# files generated by GNU Indent
FMT = ${SRC:=~} ${HDR:=~} parser.y~

.PHONY: badlib

# Target-specific variables
#sanitize: CFLAGS += ${SANITIZE}
debug: CFLAGS += ${DEBUG}
warn: CFLAGS += ${WARN}
paranoid: CFLAGS += ${SANITIZE} ${WARN} ${DEBUG}

all : ${DEPFILE} ${EXECNAME}

#sanitize : ${DEPFILE} ${EXECNAME}

warn : ${DEPFILE} ${EXECNAME}

debug : ${DEPFILE} ${EXECNAME}

paranoid : ${DEPFILE} ${EXECNAME}

${EXECNAME} : ${OBJ} ${LIBOBJ}
	${C} ${CFLAGS} -o $@ $^

badlib:
	git submodule update --init --recursive badlib

yylex.o : yylex.c
	${CYY} ${CFLAGS} -c $^

yyparse.o : yyparse.c yyparse.h
	${CYY} ${CFLAGS} -c $^

${LIBOBJ}&: badlib
	make -C badlib/ objects
	cp $(foreach file, ${LIBOBJ}, badlib/${file}) ./

${LIBHDR}: badlib

%.o : %.c ${ALLHDR}
	${C} ${CFLAGS} -c $^

yylex.c : scanner.l
	flex --outfile=yylex.c scanner.l

yyparse.h yyparse.c : parser.y
	bison -Wall -v --defines=yyparse.h --output=yyparse.c parser.y

clean:
	rm -f ${OBJ} ${GENSRC} ${GENHDR} ${DEPFILE} ${GCH}

spotless: clean
	rm -f ${EXECNAME} ${FMT} *.output *.out

cleantest:
	rm -f *.str *.tok *.ast *.sym *.oil

ci: 
	git add ${HDR} ${SRC} ${MAKEFILE} README.md DESIGN.md TODO.md DESIGN2.md \
	IDEAS.md .gitignore parser.y scanner.l

${DEPFILE}: ${ALLSRC}
	@ touch $@
	makedepend -f$@ -Y -- ${CFLAGS} -- ${ALLSRC}

depend: ${DEPFILE}

indent:
	indent -l80 -nfca -hnl -ncdb -bad -bap -nbc -bbo -nbfda -npsl -br -brs \
	-brf -ce -cdw -lps -saf -sai -saw -pcs -cs -bs -nut -ts4 -i4 -pi4 -ci4 \
	-cli4 -ppi4 -cbi0 -bli0 ${SRC} ${HDR} parser.y

format:
	clang-format --style=Google -i ${SRC} ${HDR} parser.y

sinclude ${DEPFILE}
